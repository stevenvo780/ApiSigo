#!/usr/bin/env node

/**
 * Script de prueba para validar conectividad con SIGO POS
 * Este script simula las operaciones b√°sicas que tu ecommerce necesita:
 * - Crear clientes
 * - Crear facturas
 * - Cambiar estados de factura
 * - Detectar eventos
 */

const axios = require('axios');
require('dotenv').config();

class SigoAPITester {
  constructor() {
    this.baseURL = process.env.SIGO_API_URL || 'https://api.sigosoftware.com';
    this.apiKey = process.env.SIGO_API_KEY;
    this.username = process.env.SIGO_USERNAME;
    this.password = process.env.SIGO_PASSWORD;
    
    console.log('üîç Configuraci√≥n SIGO:');
    console.log(`- URL Base: ${this.baseURL}`);
    console.log(`- API Key configurada: ${!!this.apiKey}`);
    console.log(`- Credenciales configuradas: ${!!(this.username && this.password)}`);
    console.log('');
  }

  async testAuthentication() {
    console.log('üì° Probando autenticaci√≥n...');
    
    try {
      // Intentar autenticaci√≥n con diferentes m√©todos
      const methods = [
        { name: 'API Key en headers', test: () => this.testApiKeyAuth() },
        { name: 'Login con usuario/contrase√±a', test: () => this.testLoginAuth() },
        { name: 'OAuth/Bearer Token', test: () => this.testBearerAuth() }
      ];

      for (const method of methods) {
        console.log(`  üîê Probando ${method.name}...`);
        try {
          await method.test();
          console.log(`  ‚úÖ ${method.name} - EXITOSO`);
          return true;
        } catch (error) {
          console.log(`  ‚ùå ${method.name} - FALL√ì: ${error.message}`);
        }
      }
      
      return false;
    } catch (error) {
      console.error('‚ùå Error en autenticaci√≥n:', error.message);
      return false;
    }
  }

  async testApiKeyAuth() {
    const response = await axios.get(`${this.baseURL}/api/auth/verify`, {
      headers: {
        'Authorization': `Bearer ${this.apiKey}`,
        'Content-Type': 'application/json'
      },
      timeout: 10000
    });
    return response.data;
  }

  async testLoginAuth() {
    const response = await axios.post(`${this.baseURL}/api/auth/login`, {
      username: this.username,
      password: this.password
    }, {
      headers: { 'Content-Type': 'application/json' },
      timeout: 10000
    });
    return response.data;
  }

  async testBearerAuth() {
    const response = await axios.get(`${this.baseURL}/api/me`, {
      headers: {
        'Authorization': `Bearer ${this.apiKey}`,
        'Content-Type': 'application/json'
      },
      timeout: 10000
    });
    return response.data;
  }

  async testClientOperations() {
    console.log('üë§ Probando operaciones de clientes...');
    
    const testClient = {
      razonSocial: 'CLIENTE PRUEBA ECOMMERCE SA',
      ruc: '20123456789',
      direccion: 'Av. Test 123, Lima',
      email: 'test@ecommerce.com',
      telefono: '999888777'
    };

    try {
      // Crear cliente
      console.log('  üìù Creando cliente de prueba...');
      const createResponse = await this.createClient(testClient);
      console.log('  ‚úÖ Cliente creado:', createResponse?.id || 'Sin ID');

      // Obtener cliente
      console.log('  üîç Obteniendo cliente...');
      const getResponse = await this.getClient(testClient.ruc);
      console.log('  ‚úÖ Cliente obtenido:', getResponse?.razonSocial || 'Sin nombre');

      // Actualizar cliente
      console.log('  ‚úèÔ∏è Actualizando cliente...');
      const updateResponse = await this.updateClient(testClient.ruc, {
        ...testClient,
        telefono: '999888666'
      });
      console.log('  ‚úÖ Cliente actualizado');

      return true;
    } catch (error) {
      console.error('  ‚ùå Error en operaciones de cliente:', error.message);
      return false;
    }
  }

  async createClient(clientData) {
    const response = await axios.post(`${this.baseURL}/api/clientes`, clientData, {
      headers: {
        'Authorization': `Bearer ${this.apiKey}`,
        'Content-Type': 'application/json'
      }
    });
    return response.data;
  }

  async getClient(ruc) {
    const response = await axios.get(`${this.baseURL}/api/clientes/${ruc}`, {
      headers: {
        'Authorization': `Bearer ${this.apiKey}`,
        'Content-Type': 'application/json'
      }
    });
    return response.data;
  }

  async updateClient(ruc, clientData) {
    const response = await axios.put(`${this.baseURL}/api/clientes/${ruc}`, clientData, {
      headers: {
        'Authorization': `Bearer ${this.apiKey}`,
        'Content-Type': 'application/json'
      }
    });
    return response.data;
  }

  async testInvoiceOperations() {
    console.log('üßæ Probando operaciones de facturas...');
    
    const testInvoice = {
      tipo_documento: 'FACTURA_VENTA',
      serie: 'FV',
      numero: Math.floor(Math.random() * 10000),
      fecha_emision: new Date().toISOString().split('T')[0],
      moneda: 'COP',
      cliente: {
        nit: '20123456789',
        razon_social: 'CLIENTE PRUEBA ECOMMERCE SA',
        direccion: 'Av. Test 123, Lima'
      },
      items: [{
        codigo_producto: 'PROD001',
        descripcion: 'Producto de prueba ecommerce',
        cantidad: 2,
        precio_unitario: 50000, // $500 COP
        valor_total: 84034, // Sin IVA
        iva_total: 15966, // IVA 19%
        precio_total: 100000 // $1000 COP total
      }],
      totales: {
        subtotal: 84034,
        iva: 15966,
        total: 100000
      }
    };

    try {
      // Crear factura
      console.log('  üìù Creando factura de prueba...');
      const createResponse = await this.createInvoice(testInvoice);
      console.log('  ‚úÖ Factura creada:', createResponse?.numero_documento || 'Sin n√∫mero');

      const serie = testInvoice.serie;
      const numero = testInvoice.numero;

      // Obtener factura
      console.log('  üîç Obteniendo factura...');
      const getResponse = await this.getInvoice(serie, numero);
      console.log('  ‚úÖ Factura obtenida:', getResponse?.estado || 'Sin estado');

      // Cambiar estado
      console.log('  üîÑ Cambiando estado de factura...');
      await this.updateInvoiceStatus(serie, numero, 'ENVIADO');
      console.log('  ‚úÖ Estado actualizado a ENVIADO');

      // Verificar estado
      console.log('  üîç Verificando estado...');
      const statusResponse = await this.getInvoiceStatus(serie, numero);
      console.log('  ‚úÖ Estado actual:', statusResponse?.estado || 'Desconocido');

      return true;
    } catch (error) {
      console.error('  ‚ùå Error en operaciones de factura:', error.message);
      return false;
    }
  }

  async createInvoice(invoiceData) {
    const response = await axios.post(`${this.baseURL}/api/facturas`, invoiceData, {
      headers: {
        'Authorization': `Bearer ${this.apiKey}`,
        'Content-Type': 'application/json'
      }
    });
    return response.data;
  }

  async getInvoice(serie, numero) {
    const response = await axios.get(`${this.baseURL}/api/facturas/${serie}/${numero}`, {
      headers: {
        'Authorization': `Bearer ${this.apiKey}`,
        'Content-Type': 'application/json'
      }
    });
    return response.data;
  }

  async updateInvoiceStatus(serie, numero, status) {
    const response = await axios.patch(`${this.baseURL}/api/facturas/${serie}/${numero}/estado`, {
      estado: status
    }, {
      headers: {
        'Authorization': `Bearer ${this.apiKey}`,
        'Content-Type': 'application/json'
      }
    });
    return response.data;
  }

  async getInvoiceStatus(serie, numero) {
    const response = await axios.get(`${this.baseURL}/api/facturas/${serie}/${numero}/estado`, {
      headers: {
        'Authorization': `Bearer ${this.apiKey}`,
        'Content-Type': 'application/json'
      }
    });
    return response.data;
  }

  async testWebhookCapabilities() {
    console.log('üîî Probando capacidades de webhooks...');
    
    try {
      // Verificar endpoints de webhook
      console.log('  üîç Verificando endpoints de webhook...');
      const webhookEndpoints = [
        `${this.baseURL}/api/webhooks`,
        `${this.baseURL}/api/webhooks/configure`,
        `${this.baseURL}/api/eventos`,
        `${this.baseURL}/api/notificaciones`
      ];

      let webhookSupported = false;
      for (const endpoint of webhookEndpoints) {
        try {
          await axios.get(endpoint, {
            headers: { 'Authorization': `Bearer ${this.apiKey}` }
          });
          console.log(`  ‚úÖ Endpoint disponible: ${endpoint}`);
          webhookSupported = true;
        } catch (error) {
          if (error.response?.status === 401) {
            console.log(`  üîê Endpoint requiere autenticaci√≥n: ${endpoint}`);
            webhookSupported = true;
          } else {
            console.log(`  ‚ùå Endpoint no disponible: ${endpoint}`);
          }
        }
      }

      return webhookSupported;
    } catch (error) {
      console.error('  ‚ùå Error verificando webhooks:', error.message);
      return false;
    }
  }

  async runFullTest() {
    console.log('üöÄ Iniciando pruebas completas de SIGO POS API');
    console.log('='.repeat(50));
    
    const results = {
      auth: false,
      clients: false,
      invoices: false,
      webhooks: false
    };

    // Test 1: Autenticaci√≥n
    results.auth = await this.testAuthentication();
    console.log('');

    // Solo contin√∫ar si la autenticaci√≥n funciona
    if (results.auth) {
      // Test 2: Operaciones de clientes
      results.clients = await this.testClientOperations();
      console.log('');

      // Test 3: Operaciones de facturas
      results.invoices = await this.testInvoiceOperations();
      console.log('');

      // Test 4: Capacidades de webhook
      results.webhooks = await this.testWebhookCapabilities();
      console.log('');
    }

    // Resumen
    console.log('üìä RESUMEN DE PRUEBAS');
    console.log('='.repeat(30));
    console.log(`üîê Autenticaci√≥n: ${results.auth ? '‚úÖ FUNCIONA' : '‚ùå FALLA'}`);
    console.log(`üë§ Clientes: ${results.clients ? '‚úÖ FUNCIONA' : '‚ùå FALLA'}`);
    console.log(`üßæ Facturas: ${results.invoices ? '‚úÖ FUNCIONA' : '‚ùå FALLA'}`);
    console.log(`üîî Webhooks: ${results.webhooks ? '‚úÖ DISPONIBLE' : '‚ùå NO DISPONIBLE'}`);
    console.log('');

    const allWorking = Object.values(results).every(r => r);
    console.log(`üéØ ESTADO GENERAL: ${allWorking ? '‚úÖ TODO FUNCIONA' : '‚ö†Ô∏è NECESITA CONFIGURACI√ìN'}`);
    
    if (!allWorking) {
      console.log('');
      console.log('üí° RECOMENDACIONES:');
      if (!results.auth) {
        console.log('- Verificar credenciales de SIGO (API_KEY, USERNAME, PASSWORD)');
        console.log('- Confirmar URL base de la API de SIGO');
        console.log('- Contactar soporte de SIGO para activar API');
      }
      if (!results.clients) {
        console.log('- Verificar permisos para gesti√≥n de clientes');
      }
      if (!results.invoices) {
        console.log('- Verificar permisos para gesti√≥n de facturas');
        console.log('- Confirmar configuraci√≥n de series y numeraci√≥n');
      }
      if (!results.webhooks) {
        console.log('- Solicitar activaci√≥n de webhooks a SIGO');
        console.log('- Configurar URLs de callback para eventos');
      }
    }

    return results;
  }
}

// Ejecutar si se llama directamente
if (require.main === module) {
  const tester = new SigoAPITester();
  tester.runFullTest().then(results => {
    process.exit(Object.values(results).every(r => r) ? 0 : 1);
  }).catch(error => {
    console.error('üí• Error fatal:', error.message);
    process.exit(1);
  });
}

module.exports = SigoAPITester;
